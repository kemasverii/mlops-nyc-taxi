<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NYC Taxi Predictor | MLOps</title>
    <!-- Tailwind CSS (via CDN for simplicity) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Custom aesthetics on top of Tailwind */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .tab-active {
            border-bottom: 2px solid #3b82f6;
            color: #3b82f6;
        }

        .tab-inactive {
            color: #6b7280;
        }

        .tab-inactive:hover {
            color: #374151;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800">

    <!-- Navbar -->
    <nav class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <i class="fas fa-taxi text-yellow-500 text-2xl mr-3"></i>
                    <h1 class="text-xl font-bold text-gray-900">NYC Taxi Predictor</h1>
                </div>
                <!-- API Status Indicator -->
                <div class="flex items-center">
                    <div id="api-status" class="flex items-center text-sm font-medium text-gray-500">
                        <span class="h-3 w-3 rounded-full bg-gray-300 mr-2"></span> Checking API...
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- Tabs -->
        <div class="mb-8 border-b border-gray-200">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button onclick="switchTab('prediction')" id="tab-btn-prediction"
                    class="tab-active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    üöÄ Prediction
                </button>
                <button onclick="switchTab('monitoring')" id="tab-btn-monitoring"
                    class="tab-inactive whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-medium text-sm">
                    üìä Monitoring & Drift
                </button>
            </nav>
        </div>

        <!-- TAB 1: PREDICTION -->
        <div id="tab-prediction" class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">

            <!-- Input Form -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-lg font-semibold mb-6 flex items-center">
                    <i class="fas fa-map-marker-alt mr-2 text-blue-500"></i> Trip Details
                </h2>

                <form id="prediction-form" onsubmit="handlePredict(event)">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Distance -->
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Trip Distance (miles)</label>
                            <input type="number" step="0.1" id="trip_distance" value="2.5"
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition">
                        </div>

                        <!-- Passengers -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Passengers</label>
                            <input type="number" min="1" max="6" id="passenger_count" value="1"
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition">
                        </div>

                        <!-- Vendor -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Vendor</label>
                            <select id="VendorID"
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition">
                                <option value="2">VeriFone Inc.</option>
                                <option value="1">Creative Mobile</option>
                            </select>
                        </div>

                        <!-- Date/Time Simulators (Since API takes raw integers) -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Hour (0-23)</label>
                            <input type="number" min="0" max="23" id="pickup_hour" value="14"
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Day of Week</label>
                            <select id="pickup_dayofweek"
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition">
                                <option value="0">Monday</option>
                                <option value="1">Tuesday</option>
                                <option value="2" selected>Wednesday</option>
                                <option value="3">Thursday</option>
                                <option value="4">Friday</option>
                                <option value="5">Saturday</option>
                                <option value="6">Sunday</option>
                            </select>
                        </div>

                        <!-- Hidden inputs/constants for simplicity -->
                        <input type="hidden" id="pickup_month" value="1">
                    </div>

                    <div class="mt-8">
                        <button type="submit"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transform transition hover:scale-[1.02] shadow-md">
                            üîÆ Predict Fare
                        </button>
                    </div>
                </form>
            </div>

            <!-- Result Panel -->
            <div class="space-y-6">
                <!-- Fare Card -->
                <div id="result-card"
                    class="bg-gradient-to-br from-blue-600 to-indigo-700 rounded-xl shadow-lg p-8 text-white hidden transform transition-all duration-500 ease-out self-start">
                    <div class="text-blue-100 text-sm font-medium uppercase tracking-wide mb-1">Estimated Fare</div>
                    <div class="flex items-baseline">
                        <span class="text-5xl font-bold" id="fare-amount">$0.00</span>
                        <span class="ml-2 text-blue-200">USD</span>
                    </div>
                </div>

                <!-- Recent History -->
                <div class="bg-white rounded-xl shadow p-6 self-start">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Recent Predictions</h3>
                        <button onclick="clearHistory()"
                            class="text-xs text-red-500 hover:text-red-700 font-medium">Clear</button>
                    </div>
                    <div id="history-list" class="space-y-3 max-h-64 overflow-y-auto">
                        <div class="text-gray-400 text-sm text-center py-4">No history yet</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 2: MONITORING -->
        <div id="tab-monitoring" class="hidden">
            <div class="bg-white rounded-xl shadow p-6 mb-6">
                <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                    <h2 class="text-lg font-bold text-gray-900">Drift Detection Dashboard</h2>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="simulateData('drift')"
                            class="px-3 py-2 bg-red-500 hover:bg-red-600 text-white text-sm font-medium rounded-lg transition">
                            <i class="fas fa-exclamation-triangle mr-1"></i> Generate Drift Data
                        </button>
                        <button onclick="simulateData('normal')"
                            class="px-3 py-2 bg-green-500 hover:bg-green-600 text-white text-sm font-medium rounded-lg transition">
                            <i class="fas fa-check-circle mr-1"></i> Generate Normal Data
                        </button>
                        <button onclick="clearLogs()"
                            class="px-3 py-2 bg-gray-500 hover:bg-gray-600 text-white text-sm font-medium rounded-lg transition">
                            <i class="fas fa-trash mr-1"></i> Clear Logs
                        </button>
                        <button onclick="fetchMonitoringData()"
                            class="px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium rounded-lg transition">
                            <i class="fas fa-sync-alt mr-1"></i> Refresh
                        </button>
                    </div>
                </div>

                <!-- Drift Metrics Grid (Evidently-powered) -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <!-- Dataset Drift -->
                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-100">
                        <div class="text-xs text-gray-500 uppercase font-semibold mb-1">Dataset Drift</div>
                        <div class="flex items-end justify-between">
                            <div class="text-2xl font-bold" id="drift-dataset-val">-</div>
                            <div id="drift-dataset-status" class="text-sm font-medium">-</div>
                        </div>
                        <div class="text-xs text-gray-400 mt-2" id="drift-dataset-detail">Evidently KS-Test</div>
                    </div>

                    <!-- Drifted Features -->
                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-100">
                        <div class="text-xs text-gray-500 uppercase font-semibold mb-1">Drifted Features</div>
                        <div class="flex items-end justify-between">
                            <div class="text-2xl font-bold" id="drift-features-val">0/0</div>
                            <div id="drift-features-pct" class="text-sm font-medium">0%</div>
                        </div>
                        <div class="h-1 w-full bg-gray-200 mt-3 rounded-full overflow-hidden">
                            <div id="drift-features-bar" class="h-full bg-purple-500 w-0 transition-all duration-500">
                            </div>
                        </div>
                    </div>

                    <!-- Overall Status -->
                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-100">
                        <div class="text-xs text-gray-500 uppercase font-semibold mb-1">Overall Status</div>
                        <div class="flex items-center mt-2" id="drift-overall-status">
                            <span
                                class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-600">
                                <span class="w-2 h-2 rounded-full bg-gray-400 mr-2"></span> Loading...
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Per-Column Drift Details -->
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-100 mb-8">
                    <h3 class="text-xs text-gray-500 uppercase font-semibold mb-3">üìã Per-Column Drift Details</h3>
                    <div id="drift-columns-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                        <div class="text-gray-400 text-sm">Loading...</div>
                    </div>
                </div>

                <!-- Model Info Card -->
                <div class="bg-blue-50 rounded-lg p-4 border border-blue-100 mb-8">
                    <h3 class="text-xs text-blue-600 uppercase font-semibold mb-2">ü§ñ Active Model</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <div>
                            <span class="text-gray-500">Name:</span>
                            <span id="model-info-name" class="font-bold text-gray-800 ml-1">-</span>
                        </div>
                        <div>
                            <span class="text-gray-500">Version:</span>
                            <span id="model-info-version" class="font-bold text-gray-800 ml-1">-</span>
                        </div>
                        <div>
                            <span class="text-gray-500">Total Predictions:</span>
                            <span id="model-info-count" class="font-bold text-gray-800 ml-1">0</span>
                        </div>
                        <div>
                            <span class="text-gray-500">Status:</span>
                            <span class="font-bold text-green-600 ml-1">‚úì Running</span>
                        </div>
                    </div>
                </div>

                <!-- Model Performance Metrics Card -->
                <div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-lg p-4 border border-purple-100 mb-8">
                    <h3 class="text-xs text-purple-600 uppercase font-semibold mb-3">üìä Model Performance Metrics
                        (Validation)</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-white rounded-lg p-3 shadow-sm">
                            <div class="text-xs text-gray-500 uppercase">MAE</div>
                            <div id="metric-mae" class="text-xl font-bold text-purple-600">-</div>
                            <div class="text-xs text-gray-400">Mean Absolute Error</div>
                        </div>
                        <div class="bg-white rounded-lg p-3 shadow-sm">
                            <div class="text-xs text-gray-500 uppercase">RMSE</div>
                            <div id="metric-rmse" class="text-xl font-bold text-indigo-600">-</div>
                            <div class="text-xs text-gray-400">Root Mean Squared Error</div>
                        </div>
                        <div class="bg-white rounded-lg p-3 shadow-sm">
                            <div class="text-xs text-gray-500 uppercase">MSE (Loss)</div>
                            <div id="metric-mse" class="text-xl font-bold text-blue-600">-</div>
                            <div class="text-xs text-gray-400">Mean Squared Error</div>
                        </div>
                        <div class="bg-white rounded-lg p-3 shadow-sm">
                            <div class="text-xs text-gray-500 uppercase">R¬≤</div>
                            <div id="metric-r2" class="text-xl font-bold text-green-600">-</div>
                            <div class="text-xs text-gray-400">Coefficient of Determination</div>
                        </div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-sm font-semibold text-gray-700 mb-4">üìä Trip Distance Distribution (Reference vs
                            Current)</h3>
                        <canvas id="chart-distance-hist"></canvas>
                    </div>
                    <div>
                        <h3 class="text-sm font-semibold text-gray-700 mb-4">üìà Avg Comparison (Bar)</h3>
                        <canvas id="chart-distance"></canvas>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
                    <div>
                        <h3 class="text-sm font-semibold text-gray-700 mb-4">üïê Pickup Hour Distribution (Reference vs
                            Current)</h3>
                        <canvas id="chart-target-hist"></canvas>
                    </div>
                    <div>
                        <h3 class="text-sm font-semibold text-gray-700 mb-4">üìà Fare Avg Comparison</h3>
                        <canvas id="chart-target"></canvas>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- State Management ---
        const API_BASE = window.location.origin; // Adapts to localhost or heroku
        let charts = {};

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            checkHealth();
            loadHistory(); // New: Load from LocalStorage
            // Start polling health
            setInterval(checkHealth, 30000);
        });

        // --- Navigation ---
        function switchTab(tabName) {
            // UI Toggle
            document.querySelectorAll('[id^="tab-btn-"]').forEach(el => {
                el.classList.remove('tab-active', 'border-b-2');
                el.classList.add('tab-inactive', 'border-transparent');
            });
            document.getElementById(`tab-btn-${tabName}`).classList.add('tab-active', 'border-b-2');
            document.getElementById(`tab-btn-${tabName}`).classList.remove('tab-inactive', 'border-transparent');

            // Content Toggle
            document.getElementById('tab-prediction').classList.add('hidden');
            document.getElementById('tab-monitoring').classList.add('hidden');
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');

            if (tabName === 'monitoring') {
                fetchMonitoringData();
            }
        }

        // --- API Interactions ---
        async function checkHealth() {
            const statusEl = document.getElementById('api-status');
            try {
                const res = await fetch(`${API_BASE}/health`);
                if (res.ok) {
                    statusEl.innerHTML = '<span class="h-3 w-3 rounded-full bg-green-500 mr-2"></span> System Online';
                } else {
                    throw new Error('API Error');
                }
            } catch (e) {
                statusEl.innerHTML = '<span class="h-3 w-3 rounded-full bg-red-500 mr-2"></span> System Offline';
            }
        }

        async function handlePredict(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            btn.disabled = true;

            const payload = {
                trip_distance: parseFloat(document.getElementById('trip_distance').value),
                passenger_count: parseInt(document.getElementById('passenger_count').value),
                pickup_hour: parseInt(document.getElementById('pickup_hour').value),
                pickup_dayofweek: parseInt(document.getElementById('pickup_dayofweek').value),
                pickup_month: parseInt(document.getElementById('pickup_month').value),
                is_weekend: 0, // Simplified
                trip_duration_minutes: 15.0 // Default
            };

            try {
                const res = await fetch(`${API_BASE}/predict`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) throw new Error(await res.text());

                const data = await res.json();

                // Show Result
                document.getElementById('fare-amount').innerText = `$${data.predicted_fare.toFixed(2)}`;

                const card = document.getElementById('result-card');
                card.classList.remove('hidden');
                card.classList.add('scale-100'); // Animation trigger if needed

                // Add to detailed history list
                addToHistory(payload, data.predicted_fare);

            } catch (err) {
                alert("Prediction Failed: " + err.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function addToHistory(input, fare) {
            const list = document.getElementById('history-list');
            const itemHTML = `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-100">
                    <div>
                        <div class="text-sm font-medium text-gray-800">${input.trip_distance} miles ‚Ä¢ ${input.passenger_count} pass.</div>
                        <div class="text-xs text-gray-500">Hour: ${input.pickup_hour}:00</div>
                    </div>
                    <div class="font-bold text-green-600">$${fare.toFixed(2)}</div>
                </div>
            `;

            // Remove "No history" text if present
            if (list.querySelector('.text-center')) list.innerHTML = '';

            // Add to UI
            const wrapper = document.createElement('div');
            wrapper.innerHTML = itemHTML;
            list.prepend(wrapper.firstElementChild);

            // Save to LocalStorage
            saveHistoryToStorage(input, fare);
        }

        // --- LocalStorage Logic ---
        function saveHistoryToStorage(input, fare) {
            let history = JSON.parse(localStorage.getItem('taxi_history') || '[]');
            history.unshift({ input, fare, timestamp: new Date().toISOString() });
            if (history.length > 10) history.pop(); // Keep last 10
            localStorage.setItem('taxi_history', JSON.stringify(history));
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('taxi_history') || '[]');
            const list = document.getElementById('history-list');

            if (history.length === 0) return; // Keep default empty msg

            list.innerHTML = ''; // Clear default msg
            history.forEach(item => {
                const itemHTML = `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-100 mb-2">
                        <div>
                            <div class="text-sm font-medium text-gray-800">${item.input.trip_distance} miles ‚Ä¢ ${item.input.passenger_count} pass.</div>
                            <div class="text-xs text-gray-500">Hour: ${item.input.pickup_hour}:00</div>
                        </div>
                        <div class="font-bold text-green-600">$${item.fare.toFixed(2)}</div>
                    </div>
                `;
                list.innerHTML += itemHTML;
            });
        }

        function clearHistory() {
            if (confirm('Are you sure you want to clear your history?')) {
                localStorage.removeItem('taxi_history');
                document.getElementById('history-list').innerHTML = '<div class="text-gray-400 text-sm text-center py-4">No history yet</div>';
            }
        }

        async function fetchMonitoringData() {
            try {
                const res = await fetch(`${API_BASE}/monitoring/drift`);
                if (!res.ok) return; // Silent fail or show placeholder

                const data = await res.json();

                // Update Model Info in card
                if (data.model_info) {
                    document.getElementById('model-info-name').innerText = data.model_info.name;
                    document.getElementById('model-info-version').innerText = data.model_info.version;
                }
                if (data.total_predictions !== undefined) {
                    document.getElementById('model-info-count').innerText = data.total_predictions;
                }

                renderCharts(data);
                updateDriftMetrics(data);

                // Fetch model performance metrics
                fetchModelMetrics();

            } catch (e) {
                console.error("Monitoring fetch failed", e);
            }
        }

        async function simulateData(mode) {
            const btn = event.target.closest('button');
            const originalHtml = btn.innerHTML;

            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Generating...';

                const res = await fetch(`${API_BASE}/monitoring/simulate?mode=${mode}`, {
                    method: 'POST'
                });

                if (res.ok) {
                    const data = await res.json();
                    alert(`‚úÖ ${data.message}\n\nAvg Distance: ${data.avg_distance.toFixed(2)} miles\nAvg Prediction: $${data.avg_prediction.toFixed(2)}`);
                    fetchMonitoringData(); // Refresh dashboard
                } else {
                    alert('‚ùå Failed to generate data');
                }
            } catch (e) {
                console.error("Simulation failed", e);
                alert('‚ùå Error: ' + e.message);
            } finally {
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        }

        async function clearLogs() {
            if (!confirm('Are you sure you want to clear all prediction logs?')) return;

            try {
                const res = await fetch(`${API_BASE}/monitoring/clear`, {
                    method: 'POST'
                });

                if (res.ok) {
                    alert('‚úÖ Prediction logs cleared');
                    fetchMonitoringData(); // Refresh dashboard
                } else {
                    alert('‚ùå Failed to clear logs');
                }
            } catch (e) {
                console.error("Clear logs failed", e);
                alert('‚ùå Error: ' + e.message);
            }
        }

        async function fetchModelMetrics() {
            try {
                const res = await fetch(`${API_BASE}/model/info`);
                if (!res.ok) return;

                const data = await res.json();

                if (data.metrics) {
                    const metrics = data.metrics;
                    document.getElementById('metric-mae').innerText = metrics.mae ? `$${metrics.mae.toFixed(4)}` : '-';
                    document.getElementById('metric-rmse').innerText = metrics.rmse ? `$${metrics.rmse.toFixed(4)}` : '-';
                    document.getElementById('metric-mse').innerText = metrics.mse ? `$${metrics.mse.toFixed(4)}` : '-';
                    document.getElementById('metric-r2').innerText = metrics.r2 ? metrics.r2.toFixed(4) : '-';
                }
            } catch (e) {
                console.error("Model metrics fetch failed", e);
            }
        }

        function updateDriftMetrics(data) {
            // Handle Evidently-based drift data
            const datasetDriftEl = document.getElementById('drift-dataset-val');
            const datasetStatusEl = document.getElementById('drift-dataset-status');
            const datasetDetailEl = document.getElementById('drift-dataset-detail');
            const featuresValEl = document.getElementById('drift-features-val');
            const featuresPctEl = document.getElementById('drift-features-pct');
            const featuresBarEl = document.getElementById('drift-features-bar');
            const overallStatusEl = document.getElementById('drift-overall-status');

            // Check for errors
            if (data.error) {
                datasetDriftEl.innerText = 'N/A';
                datasetStatusEl.innerText = '';
                datasetDetailEl.innerText = data.error;
                featuresValEl.innerText = '0/0';
                featuresPctEl.innerText = '0%';
                overallStatusEl.innerHTML = `
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">
                        <span class="w-2 h-2 rounded-full bg-yellow-500 mr-2"></span> ${data.total_predictions || 0} predictions
                    </span>`;
                return;
            }

            // Evidently results
            if (data.evidently_available) {
                // Dataset drift
                const isDrifted = data.dataset_drift;
                datasetDriftEl.innerText = isDrifted ? '‚ö†Ô∏è YES' : '‚úÖ NO';
                datasetDriftEl.className = `text-2xl font-bold ${isDrifted ? 'text-red-600' : 'text-green-600'}`;
                datasetStatusEl.innerText = isDrifted ? 'Drift Detected' : 'Stable';
                datasetStatusEl.className = `text-sm font-medium ${isDrifted ? 'text-red-500' : 'text-green-500'}`;
                datasetDetailEl.innerText = 'Evidently KS-Test (p<0.05)';

                // Drifted features
                const nDrifted = data.n_drifted || 0;
                const nFeatures = data.n_features || 0;
                const driftPct = nFeatures > 0 ? (nDrifted / nFeatures * 100) : 0;

                featuresValEl.innerText = `${nDrifted}/${nFeatures}`;
                featuresPctEl.innerText = `${driftPct.toFixed(0)}%`;
                featuresPctEl.className = `text-sm font-medium ${driftPct > 30 ? 'text-red-500' : 'text-green-500'}`;
                featuresBarEl.style.width = `${driftPct}%`;
                featuresBarEl.className = `h-full transition-all duration-500 ${driftPct > 30 ? 'bg-red-500' : 'bg-purple-500'}`;

                // Overall status
                if (isDrifted) {
                    overallStatusEl.innerHTML = `
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800">
                            <span class="w-2 h-2 rounded-full bg-red-500 mr-2"></span> Drifted
                        </span>`;
                } else {
                    overallStatusEl.innerHTML = `
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                            <span class="w-2 h-2 rounded-full bg-green-500 mr-2"></span> Healthy
                        </span>`;
                }

                // Per-column drift details
                const columnsListEl = document.getElementById('drift-columns-list');
                if (data.features && Object.keys(data.features).length > 0) {
                    columnsListEl.innerHTML = Object.entries(data.features).map(([col, info]) => {
                        const isDrift = info.drift_detected;
                        const score = info.drift_score !== null ? info.drift_score.toFixed(3) : 'N/A';
                        const threshold = info.stattest_threshold || 0.3;
                        return `
                            <div class="flex items-center justify-between p-3 rounded-lg ${isDrift ? 'bg-red-50 border border-red-200' : 'bg-green-50 border border-green-200'}">
                                <div class="flex items-center">
                                    <span class="text-lg mr-2">${isDrift ? '‚ö†Ô∏è' : '‚úÖ'}</span>
                                    <span class="font-medium text-gray-800">${col}</span>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm font-mono ${isDrift ? 'text-red-600' : 'text-green-600'}">${score}</div>
                                    <div class="text-xs text-gray-400">threshold: ${threshold}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    columnsListEl.innerHTML = '<div class="text-gray-400 text-sm col-span-3">No feature drift data available. Need at least 30 predictions.</div>';
                }
            } else {
                // Fallback for non-Evidently
                datasetDriftEl.innerText = '-';
                datasetStatusEl.innerText = 'Not available';
                overallStatusEl.innerHTML = `
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-600">
                        <span class="w-2 h-2 rounded-full bg-gray-400 mr-2"></span> Pending
                    </span>`;
                document.getElementById('drift-columns-list').innerHTML = '<div class="text-gray-400 text-sm">Evidently not available</div>';
            }
        }

        function renderCharts(data) {
            const ctx1 = document.getElementById('chart-distance').getContext('2d');
            const ctx2 = document.getElementById('chart-target').getContext('2d');
            const ctxHistDist = document.getElementById('chart-distance-hist').getContext('2d');
            const ctxHistTarget = document.getElementById('chart-target-hist').getContext('2d');

            // Destroy existing charts
            Object.values(charts).forEach(c => c && c.destroy());

            // Bar chart: Comparing Means
            charts.dist = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: ['Reference (Training)', 'Current (Production)'],
                    datasets: [{
                        label: 'Avg Trip Distance (miles)',
                        data: [data.reference.trip_distance?.mean || 0, data.current.trip_distance?.mean || 0],
                        backgroundColor: ['#3b82f6', '#10b981']
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });

            charts.target = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: ['Reference', 'Current'],
                    datasets: [{
                        label: 'Avg Fare ($)',
                        data: [data.reference.fare_amount?.mean || 0, data.current.fare_amount?.mean || 0],
                        backgroundColor: ['#a855f7', '#22c55e']
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });

            // Overlapping Histogram: Distance Distribution (Reference vs Current)
            if (data.histograms?.trip_distance) {
                const histData = data.histograms.trip_distance;
                charts.distHist = new Chart(ctxHistDist, {
                    type: 'bar',
                    data: {
                        labels: histData.labels,
                        datasets: [
                            {
                                label: 'Reference (Training)',
                                data: histData.reference,
                                backgroundColor: 'rgba(59, 130, 246, 0.7)',
                                borderColor: '#3b82f6',
                                borderWidth: 1
                            },
                            {
                                label: 'Current (Production)',
                                data: histData.current,
                                backgroundColor: 'rgba(16, 185, 129, 0.7)',
                                borderColor: '#10b981',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: true, position: 'top' } },
                        scales: {
                            x: { title: { display: true, text: 'Distance (miles)' } },
                            y: { title: { display: true, text: 'Percentage (%)' } }
                        }
                    }
                });
            }

            // Overlapping Histogram: Pickup Hour Distribution
            if (data.histograms?.pickup_hour) {
                const histData = data.histograms.pickup_hour;
                charts.targetHist = new Chart(ctxHistTarget, {
                    type: 'bar',
                    data: {
                        labels: histData.labels,
                        datasets: [
                            {
                                label: 'Reference (Training)',
                                data: histData.reference,
                                backgroundColor: 'rgba(168, 85, 247, 0.7)',
                                borderColor: '#a855f7',
                                borderWidth: 1
                            },
                            {
                                label: 'Current (Production)',
                                data: histData.current,
                                backgroundColor: 'rgba(34, 197, 94, 0.7)',
                                borderColor: '#22c55e',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: true, position: 'top' } },
                        scales: {
                            x: { title: { display: true, text: 'Pickup Hour' } },
                            y: { title: { display: true, text: 'Percentage (%)' } }
                        }
                    }
                });
            }
        }
    </script>
</body>

</html>